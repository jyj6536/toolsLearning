# tar 与 gzip

## tar命令

tar 是一个归档实用程序。

GNU tar 是一个归档程序，旨在将多个文件存储在一个文件（一个归档文件）中，并操作这些归档文件。归档可以是常规文件或设备（例如，磁带驱动器，因此程序的名称代表磁带归档），可以位于本地或远程计算机上。

### 选项风格

传递给 GNU tar 的选项可以有三种不同的风格。在传统风格中，第一个参数是一组选项字母，所有后续参数为需要它们的选项提供参数。参数的读取顺序与选项字母的读取顺序相同。处理完所有选项后保留的任何命令行单词都将被视为非可选参数：文件或归档成员名称。

例如，c 选项要求创建归档，v 选项要求执行详细操作，f 选项采用一个参数来设置要操作的归档的名称。以下命令以传统样式编写，指示 tar 将目录 `/etc` 中的所有文件存储到归档文件 `etc.tar` 中，详细列出要归档的文件：

```shell
tar cfv etc.tar /etc
```

在 UNIX 或短选项风格中，与其他命令行实用程序一样，每个选项字母都以单破折号作为前缀。如果某个选项采用参数，则该参数将作为单独的命令行单词跟随它，或者紧跟在该选项之后。但是，如果选项采用可选参数，则参数必须跟在选项字母后面，中间没有任何空格，例如 `-g/tmp/snar.db`。

任意数量的无参选项都可以被聚集在一起放在一个单破折号之后，例如 `-vkp`。需要参数的选项（无论是强制的还是可选的）可以出现在这样的集合之后，例如 `-vkpf a.tar`。

以短选项风格改写上面的例子：

```shell
tar -cvf etc.tar /etc
#或者
tar -c -v -f etc.tar /etc
```

在 GNU 或长选项风格中，每个选项以两个破折号开头，并有一个有意义的名称，由小写字母和破折号组成。使用时，长选项可以缩写为其首字母，前提是这不会产生歧义。长选项的参数可以作为一个单独的命令行单词提供，紧跟在选项后面，或者用等号与选项分隔，中间没有空格。可选参数必须始终使用后一种方法。

下面是几个以该风格改写样例命令的方式：

```shell
tar --create --file etc.tar --verbose /etc
或者（缩写某些选项）
tar --cre --file=etc.tar --verb /etc
```

所有三种风格的选项可以被混用，尽管对于旧选项不鼓励这样做。

### 选项模式

下列选项告诉 GNU tar 要执行什么操作。这些选项每次只能给定一个。

+ -A, --catenate, --concatenate 将归档附加到另一个归档的末尾。参数被视为要附加的归档文件的名称。所有归档文件的格式必须与附加到的归档文件相同，否则生成的归档文件可能无法用于 tar 的非 GNU 实现。还要注意，如果给定了多个归档文件，则只有使用 -i（--ignore zeros）选项时，才能在生成的归档文件中访问除第一个归档文件之外的其他归档文件中的成员。

  压缩归档不能被附加。

+ -c, --create 创建一个新归档。参数提供了要归档的文件名。目录会被递归的归档除非指定了 `--no-recursion`。

+ -d, --diff, --compare 查找归档和文件系统之间的差异。参数是可选的，并指定要比较的归档成员。如果未给出，则假定当前工作目录。

+ --delete 从归档中删除。参数提供了要删除的归档成员。至少需要一个参数。

  该选项不能用于压缩归档并且没有等价的短形式。

+ -r, --append 在归档的末尾追加文件。参数与 -c (--create) 具有相同含义。

+ -t, --list 列出归档内容。参数是可选的。如果给定则指定了要列出的成员名字。

+ -u, --update 追加文件，这些文件比归档中的拷贝更新。参数与 -c 或 -r 具有相同含义。注意，更新的文件不会替代旧的归档拷贝，而是追加到归档末尾。因此，生成的归档可以包含多个同名成员，对应于同一文件的不同版本。

+ -x, --extract, --get 从归档中展开文件。参数是可选的。如果给定则指定了要展开的成员名字。

+ --show-defaults 展示不同 tar 选项的内置默认值并退出。不允许附加任何参数。

+ -?, --help 打印简短的选项摘要并退出。不允许附加任何参数。

+ --usage 打印可用的选项列表并退出。不允许附加任何参数。

+ --version 打印程序版本和版权信息并退出。

### 常用选项

+ -k, --keep-old-files 展开时不要替换以存在的文件。

+ --keep-newer-files 不要替换比其归档拷贝更新的文件。

+ --overwrite 展开时替换已存在的文件。

+ --remove-files 在将文件添加到归档中后删除他们。

+ -O, --to-stdout 展开到标准输出。

+ -f, --file=*ARCHIVE* 使用归档文件或设备 *ARCHIVE*。如果未提供此选项，tar 将首先检查环境变量 `TAPE`。如果已设置，则其值将用作归档名称。否则，tar 将使用默认的编译值。可以使用 `--show-defaults` 选项或在 `tar --help` 输出的末尾检查默认值。

  包含冒号的归档名指定了远程主机上的文件或设备。冒号之前的部分被当作主机名或者 IP 地址，之后的部分被当作文件或这被路径名，例如：

  ```shell
  --file=remotehost:/dev/sr0
  ```

  一个可选的用户名可以被添加到主机名签名，以 `@` 分隔。

  默认地，远程主机通过rsh(1) 命令访问。现在更常见的做法是使用 [ssh(1)](https://man7.org/linux/man-pages/man1/ssh.1.html) 替代。可以通过下列命令行选项实现此目的：

  ```shell
  --rsh-command=/usr/bin/ssh
  ```

  远程主机应该安装 rmt(8) 命令。如果它的路径名不匹配 tar 的默认值，可以使用 `--rmt-command` 选项通知 tar 正确的路径名。

+ -a, --auto-compress 根据归档后缀决定压缩程序。

+ -j, --bzip2 使用 bzip2(1) 进行压缩。

+ -z, --gzip, --gunzip, --ungzip 使用 gzip(1) 进行压缩。

+ -C, --directory=DIR 在开始任何操作之前将目录切换到 *DIR*。

+ -v, --verbose 详细列出已处理的文件。命令行中每一个该选项的实例都会使冗余级别提升1。最大的冗余级别是3。关于不同的冗余级别如何影响 tar 的输出，请参考 **GNU Tar Manual** 2.5.1小节，**The --verbose Option**。

### 返回值

tar 的退出码表明其是否成功处理了请求的操作，如果没有，发生了什么错误。

+ 0 成功退出。
+ 1 某些文件不同。如果通过 --compare（--diff, -d）命令行选项调用 tar，这意味着归档中的某些文件与其磁盘上的对应文件不同。如果 tar 被指定了 --create, --append 或者 --update 选项，那么该退出码意味着在归档过程中某些文件被改变，因此生成的存档不包含文件集合的确切副本。
+ 2 致命错误。这意味着某些致命的，不可恢复的错误发生了。

如果 tar 调用的子进程以非0退出码退出，那么 tar 自身也会以该退出码退出。这是可能发生的，例如，如果指定了压缩选项（例如，-z）并且为外部压缩程序失败。其他的例子是在备份到远程设备时 rmt 失败。

### 官方文档

[tar(1) — Linux manual page](https://man7.org/linux/man-pages/man1/tar.1.html)

## gzip

### 简介

gzip [ -acdfhklLnNrtvV19 ] [-S suffix] [ name ...  ]

gunzip [ -acfhklLnNrtvV ] [-S suffix] [ name ...  ]

zcat [ -fhLV ] [ name ...  ]

### 描述

gzip 使用 Lempel-Ziv 编码（LZ77）减小文件体积。如果可能的话，每个文件都会被扩展名为 `.gz`  的文件代替，并且保持相同的所有权模式，访问和修改时间（对于 MSDOS，OS/2 FAT，Windows NT FAT 和 Atari，默认的扩展名是 z）。如果没有文件被指定，或者指定的是 -，标准输入会被压缩并输出到标准输出。gzip 仅仅会尝试压缩普通文件。特别地，gzip 会忽略符号链接。

如果压缩文件名对其文件系统来说太长，gzip 会将其截断。gzip尝试只截断文件名每一部分中超过3个字符的部分（文件名由点分隔成各个部分）。例如，如果文件名限制为14个字符，则 `gzip.msdos.exe` 压缩为 `gzi.msd.exe.gz`。在没有文件名长度限制的系统上，名称不会被截断。

默认情况下，gzip 在压缩文件中保留原始文件名和时间戳。在使用-N选项解压缩文件时使用这些选项。当压缩文件名被截断或文件传输后时间戳未保留时，这非常有用。

压缩文件可以使用 `gzip -d` 或 gunzip 或 zcat 还原为原始形式。如果保存在压缩文件中的原始名称不适合其文件系统，则会根据原始名称构造一个新名称以使其合法。

gunzip在命令行中获取一个文件列表，并用一个没有原始扩展名的未压缩文件替换每个以 `.gz`、`-gz`、`.z`、`-z`或`_z`（忽略大小写）结尾、以正确魔术数字开头的文件。gunzip 也会把 `.tgz` 和 `.taz` 分别看作 `.tar.gz` 和 `.tar.Z` 的缩写。压缩时，如果需要，gzip 使用 `.tgz` 扩展名，而不是截断扩展名为 `.tar` 的文件。

gunzip目前可以解压缩由 gzip、zip、`compress -H`或 pack 创建的文件。输入格式的检测是自动的。使用前两种格式时，gunzip 检查32位CRC。对于 pack 和gunzip，检查未压缩的长度。标准压缩格式的设计不允许进行一致性检查。然而，gunzip 有时能够检测到坏的 `.Z` 文件。如果在解压缩 `.Z` 文件时出现错误，不要仅仅因为标准解压缩没有问题就认为 `.Z` 文件是正确的。这通常意味着标准解压缩不检查其输入，并且很乐意生成垃圾输出。SCO压缩 -H 格式（lzh压缩方法）不包括CRC，但也允许一些一致性检查。

只有当zip创建的文件有一个用 “defraction” 方法压缩的成员时，才能用 gzip 解压缩。此功能仅用于帮助将 `tar.zip` 文件转化为 `tar.gz` 格式。要提取包含单个成员的zip文件，请使用命令 `gunzip  <foo.zip` 或 `gunzip  -S  .zip  foo.zip`。要提取包含多个成员的zip文件，请使用 unzip 而不是 gunzip。

zcat 与 `gunzip -c` 相同（在某些系统上，zcat可能安装为gzcat，以保留原始链接进行压缩。）zcat 解压缩命令行或其标准输入上的文件列表，并将未压缩的数据写入标准输出。zcat将解压缩具有正确幻数的文件，无论它们是否具有 .gz 后缀。 

gzip 使用 zip 和 PKZIP中使用的 Lempel-Ziv 算法。获得的压缩量取决于输入的大小和公共子串的分布。通常，源代码或英语等文本会减少60-70%。压缩通常比LZW（用于印刷）、霍夫曼编码（用于包装）或自适应霍夫曼编码（紧凑）实现的压缩要好得多。

即使压缩文件略大于原始文件，也始终执行压缩。最坏的扩展是gzip文件头的几个字节，加上每32K块5个字节，或者对于大文件，扩展率为0.015%。请注意，实际使用的磁盘块数几乎从未增加。gzip在压缩或解压缩时保留文件的模式、所有权和时间戳。

### 选项

+ -a --ascii Ascii 文本模式：使用本地惯例转换行尾。仅在某些非Unix系统上支持此选项。对于 MSDOS，压缩时将 CR LF 转换为 LF，解压缩时将 LF 转换为CR LF。

+ -c --stdout --to-stdout 将输出写入标准输出；保持原始文件不变。如果有多个输入文件，则输出由一系列独立压缩的成员组成。要获得更好的压缩效果，请在压缩所有输入文件之前将它们连接起来。 

+ -d --decompress --uncompress 解压。

+ -f --force 即使文件具有多个链接或相应的文件已经存在，或者从终端读取或写入压缩数据，也强制压缩或解压缩。

+ -h --help 显示帮助屏幕并退出。

+ -k --keep 压缩或解压期间保持输入文件（不要删除）。

+ -l --list 对于每一个压缩文件，列出下列域：

  + 压缩大小：压缩文件的大小
  + 未压缩大小：未压缩文件的大小
  + 比率：压缩率（未知则为 0.0%）
  + 未压缩名：未压缩文件的名字

  对于非gzip格式的文件（如压缩的 .Z 文件），未压缩的大小为-1。要获取此类文件的未压缩大小，可以使用：

  ```shell
  zcat file.Z | wc -c
  ```

  与 --verbose 选项合用还会显示下列域：

  + 方法：压缩方法
  + crc：未压缩数据的32比特CRC校验和
  + 日期 & 时间：未压缩文件的时间戳

+ -L --license 显示 gzip 许可证并退出。

+ -n --no-name 压缩时，默认情况下不要保存原始文件名和时间戳。（如果必须截断名称，则始终保存原始名称。）解压缩时，不要还原原始文件名（如果存在）（仅从压缩文件名中删除gzip后缀），也不要还原原始时间戳（如果存在，则从压缩文件中复制）。此选项是解压时的默认选项。

+ -N --name 与 -n 选项作用相反。

+ -q --quiet 压缩所有告警。

+ -r --recursive 递归地遍历目录结构。对于命令行中指定的任何是目录的文件名，gzip将进入到目录中并压缩它在其中找到的所有文件（或者在gunzip的情况下解压缩它们）。

+ -S .suf --suffix .suf 压缩时，使用后缀.suf而不是.gz。可以给出任何非空后缀，但应避免使用.z和.gz以外的后缀，以避免文件传输到其他系统时发生混淆。解压缩时，在从输入文件名派生输出文件名时，在后缀列表的开头添加.suf。

+ --synchronous 使用同步输出。使用此选项，gzip在系统崩溃时丢失数据的可能性较小，但速度可能会慢得多。

+ -t --test 测试。检查压缩文件的完整性。

+ -v --verbose 显示每个压缩或解压缩文件的名称和压缩百分比。

+ -V --version 显示版本号和编译选项并退出。

+ -# --fast --best #是一个介于1-9之间的整数，预设值为6，1代表最快速度（压缩率最低），9代表最高效率（速度最慢），--fast等价于-1，--best等价于-9。

+ --rsyncable 当在两台计算机之间同步压缩文件时，此选项允许 rsync 仅传输存档中更改的文件，而不是整个存档。通常，在对存档中的任何文件进行更改后，压缩算法可以生成与存档的先前版本不匹配的存档的新版本。在这种情况下，rsync 会将整个新版本的归档文件传输到远程计算机。使用此选项，rsync可以仅传输已更改的文件以及更新已更改区域中的存档结构所需的少量元数据。

### 高级用法

可以连接多个压缩文件。在这种情况下，gun-zip将立即提取所有成员。例如：

```shell
gzip -c file1  > foo.gz
gzip -c file2 >> foo.gz
```

接下来

```shell
gunzip -c foo
```

等价于

```shell
cat file1 file2
```

如果.gz文件的一个成员损坏，其他成员仍可恢复（如果已删除损坏的成员）。但是，通过一次压缩所有成员，可以获得更好的压缩效果：

```shell
cat file1 file2 | gzip > foo.gz
```

压缩效果更好

```shell
gzip -c file1 file2 > foo.gz
```

如果要重新压缩连接的文件以获得更好的压缩效果，请执行以下操作：

```shell
gzip -cd old.gz | gzip > new.gz
```

如果压缩文件由多个成员组成，则--list选项报告的未压缩大小和CRC仅适用于最后一个成员。如果需要所有成员的未压缩大小，可以使用：

```shell
gzip -cd file.gz | wc -c
```

如果希望创建一个包含多个成员的归档文件，以便以后可以独立提取成员，请使用tar或zip等归档文件。GNU tar支持 -z 选项以透明地调用 gzip。gzip 被设计为对 tar 的补充，而不是替代。

### 官方文档

[GZIP(1)](https://linuxcommand.org/lc3_man_pages/gzip1.html)