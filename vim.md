# vim

vim 是最流行的文本编辑器之一。它是 Vi 的克隆，由 Bram Moolenaar 编写。它是跨平台的，在类似于 Windows、Linux、Max 以及其他 Unix 变体的最流行的平台上都是可用的。它是一个以命令为中心的编辑器，所以初学者可能发现用起来很难。但是一但掌握了使用方法，使用者可用通过少量 vim 命令解决复杂的文本相关任务。

## 编辑

### buffer

buffer 是由 vim 使用的临时内存。当打开文件的时候，vim 将文件内容装载到内存中。编辑完成后内存中的内容会被写回到文件中。

### swap

交换区是由 vim 创建的周期性保存 buffer 内容的文件。通过 :swapname 可以查看当前交换区文件的名字。

### 编辑命令

在命令模式下，通过以下命令可以进入插入编辑模式（包括插入、添加、替换等）

|    命令     |                             效果                             |
| :---------: | :----------------------------------------------------------: |
|      i      |              进入插入模式，光标保持当前位置不动              |
|      I      |                 进入插入模式，光标移动到行首                 |
|      a      |                进入插入模式，光标向后移动一格                |
|      A      |                 进入插入模式，光标移动到行尾                 |
|      o      |                     在当前行下方插入新行                     |
|      O      |                     在当前行上方插入新行                     |
|      s      |                  删除当前字符并进入插入模式                  |
|      S      |              删除当前行的所有内容并进入插入模式              |
|     cc      |              删除当前行的所有内容并进入插入模式              |
|      C      |                 从当前光标位置开始删除到行尾                 |
|      r      |                         替换当前字符                         |
|      R      |                进入替换模式，持续替换后续字符                |
|      J      |              连接当前行以及下一行（以空格分割）              |
|      x      |                         剪切当前字符                         |
|      X      |                        剪切前一个字符                        |
|      y      |                         复制当前字符                         |
|      p      |                 在光标之后粘贴当前复制的字符                 |
|      P      |                 在光标之前粘贴当前复制的字符                 |
|     dw      |                       剪切光标所在的词                       |
|      D      |        剪切光标所在位置直到行尾的内容（不包含换行符）        |
|  dd/d$/d^   | 剪切光标所在的行（包含换行符）/从光标开始剪切到行尾/从光标开始剪切到行首 |
|    yy/Y     |                           复制整行                           |
|      u      |                      撤销上一个编辑操作                      |
| :red/Ctrl+r |                      恢复上一个编辑操作                      |
|      U      |                撤销所有在前一个编辑行上的操作                |

## 导航

vim 对高级导航操作有很好的支持。

### 基本导航命令

包括h（⬅）、l（➡）、j（⬇）、k（⬆），0/^/home 移动到当前行首，$/End 移动到当前行尾，Ctrl+f/PgDN 向下翻页，Ctrl+b/PgUp 向上翻页。

### 跳转到指定行

gg —— 跳转到第一行

G —— 跳转到最后一行

nG —— 跳转到第 n 行

:0 —— 跳转到第一行

:n —— 跳转到 nth 行

:$ —— 跳转到最后一行

### 跳转记录

vim 使用跳转列表跟踪导航记录。:jumps 可以查看当前的跳转列表。

Ctrl+o —— 跳转到之前的位置

Ctrl+i —— 跳转到下一个位置

## 搜索与替换

新建 .vimrc 文件，并写入以下配置

~~~~
set nu #显示行号
set incsearch #增量搜索
set hlsearch #高亮显示
~~~~

| 命令           | 效果                                       |
| -------------- | ------------------------------------------ |
| /<expression\> | 向前搜索                                   |
| ?<expression\> | 向后搜索                                   |
| n/N            | 向当前方向搜索/向当前方向的反向搜索        |
| //，??         | 执行上一次 / 搜索，执行上一次 ？ 搜索      |
| *，#           | 向前搜索光标所在的词，向后搜索光标所在的词 |

vim 中基本的替换命令为 `:[range]s/目标字符串/替换字符串/[option]`，各部分的含义如下

+ range：表示替换范围，默认替换当前行。`1,10` 表示从第1行到第10行，`.,$` 表示从当前行当最后一行，`%` 表示整个文件，相当于 `1,$`
+ s：substitute 的缩写，表示替换
+ option：选项，g 表示替换某一行中的全部匹配，i 表示不区分大小写，I表示区分大小写，c 表示替换时需要确认

执行  [:h s_flags](https://vimhelp.org/change.txt.html#%3As_flags) 可以查看所有 option 及其详细含义。

### 锚点

默认情况下，正则表达式可以匹配文本中的任意位置。可以使用行和词锚点来指定有关匹配位置的其他限制。

+ ^ 匹配行 的开始
+ $ 匹配行的结束
+ ^$ 匹配空行
+ \\<pattern\\> 匹配词的开始和结束，可以单独使用
  + 词包括数字、字母和下划线

### dot 字符

+ **.** 匹配除了换行符以外的任何单个字符
+ **\\_.** 匹配任何单个字符，包括换行符

### 贪婪量词

量词可以应用于文字字符、点元字符、组、反向引用和字符类。

+ \* 匹配任意次

  + abc* 匹配 ab、abc、abcc
  + Error.*valid 匹配 Error: invalid input
+ \\+ 至少匹配一次
+ \\? 至多匹配一次

  + \\= 也可以使用，这在使用 ? 进行反向搜索时是非常有帮助的
  + ab\? 匹配 abc 或者 ad，也可以匹配 abccccc 中的 abc
+ \\{m,n},\\{m,},\\{,n},\\{n} 匹配 m 至 n 次，至少匹配 m 次，至多匹配 n 次，恰好匹配 n 次

  + ab\{1,4}c 匹配 abc、abcc、abccc、abcccc
  + 也可以使用 \\{m,n\\},\\{m,\\},\\{,n\\},\\{n\\}


贪婪量词会尽可能多地匹配字符，前提是整体模式也匹配。 [:h pattern-overview](https://vimhelp.org/pattern.txt.html#pattern-overview) 可以查看详细信息。

### 非贪婪量词

非贪婪量词会尽可能少地匹配字符。

+ \\{-} 尽可能少地匹配任意次
  + `s/t.\{-}a/X/g` 使用 `XX fabricaXle` 替换 `that is quite a fabricated tale`
    + 匹配的部分是 `tha`、`t is quite a` 以及 `ted ta`
  + `s/t.*a/X/g`  使用 `Xlt` 替换 `that is quite a fabricated tale`
+ \\{-m,n} 尽可能少地匹配 m 至 n 次

### 字符类

使用 `[]` 可以创建一个字符的集合。字符类支持自己版本的元字符并且提供特殊的预定义集合以供通常使用。

|      字符类       |                  含义                  |
| :---------------: | :------------------------------------: |
| [aeiou]、[a-z0-9] |  匹配小写元音字母、匹配小写字母与数字  |
|        \a         |                [a-zA-Z]                |
|        \A         |               [^a-zA-Z]                |
|        \l         |                 [a-z]                  |
|        \L         |                 [^a-z]                 |
|        \d         |                 [0-9]                  |
|        \D         |                 [^0-9]                 |
|        \o         |      匹配八进制字符，相当于[0-7]       |
|        \O         |                 [^0-7]                 |
|        \h         |               [a-zA-Z_]                |
|        \H         |               [^a-zA-Z_]               |
|        \x         |     匹配十六进制字符，[0-9a-fA-F]      |
|        \X         |              [^0-9a-fA-F]              |
|        \w         | 匹配字母数字下划线，相当于[a-zA-Z0-9_] |
|        \W         |             [^a-zA-Z0-9_]              |
|        \s         |     匹配空格和制表符，相当于[ \t]      |
|        \S         |                 [^ \t]                 |

转移序列在 `[]` 中失去特殊含义。

例子

+ `c[ou]t` 匹配 `cot` 、 `cut`
+ `\<[ot][on]\>` 匹配词 `oo` 、 `on` 、 `to` 、 `tn`
+ `s/"[^"]\+"/X/g` 将 `"mango" and "(guava)"` 替换为 `X and X`
+ `s/\d\+/-/g` 将 `Sample123string777numbers`  替换为 `Sample-string-numbers`
+ `s/\<0*[1-9]\d\{2,}\>/X/g` 将 `0501 035 26 98234` 替换为 `X 035 26 X`（匹配大于100的具有可选前导0的整数）
+ `s/\W\+/ /g` 将 `load2;err_msg--\ant` 替换为  `load2 err_msg ant`

### 或和分组

+ \\| 匹配任一模式
  + `max\|min`  匹配 `max` 或者 `min`
+ `\(pattern\)` 创建分组
  + `a\(123\|456\)b` 等价于 `a123b\|a456b`
  + `hand\(y\|ful\)\?` 匹配 `hand` 或 `handy` 或 `handful`

对于或有一些情况会导致歧义。

+ `s/are\|spared/X/g` 将 `rare spared area` 替换为 `rX X Xa`
  + `s/spared\|are/X/g` 会得到相同的结果
+ `s/spa\|spared/**/g` 将 `spared spare`  替换为 `**red **re`
+ `s/spared\|spa/**/g` 将 `s/spared\|spa/**/g` 替换为  `** **re`

对于或的两部分中一部分是另一部分子串的情况，先匹配的部分先生效

### 反向引用

分组捕获的字符串可以之后被反向引用 `\N` 所引用，其中 N 是需要引用的分组。

+ `\(pattern\)` 捕获分组以备后续反向引用之用
+ `\%(pattern\)` 非捕获分组
+ 最左边的分组是1，之后是2，依此类推，最大是9；\\1 反向引用第一个捕获分组，\\2 反向引用第二个捕获分组，\\9 反向引用第九个捕获分组
+ `&` 或 `\0` 引用完整的匹配

以下是一些例子

+ `\(\a\)\1` 匹配 `aa`、`TT` 等重复字母
+ `\(\a\)\1\+` 匹配至少两个重复字母的词，比如 `aa`、`ttt`、`EEEE`
+ `s/\d\+/(&)/g` 将 `52 apples 31 mangoes` 替换为 `(52) apples (31) mangoes`（`&` 代表完整的匹配项目）
+ `s/\(\w\+\),\(\w\+\)/\2,\1/g` 将  `good,bad 42,2`  替换为 `bad,good 24,42`
+ `s/\(\d\{4}\)-\(\d\{2}\)-\(\d\{2}\)/\1\/\2\/\3/g` 将 `2023-01-02` 替换为 `2023/01/04`

指向匹配具有量词的捕获分组的文本的引用仅会给出最后一次匹配的内容，而不是整个匹配。

+ `s/a \(\d\{3}\)\+/b (\1)/` 将 `123456789` 替换为 `b (789)`，`a 4839235` 替换为 `b (923)5`
+ `s/a \(\%(\d\{3}\)\+\)/b (\1)/` 将 `a 123456789` 替换为 `a (123456789)`，`a 4839235` 替换为 `b (483923)5`

### 环视

环视有助于创建自定义锚点并在搜索模式中添加条件。这些断言也被称为零宽模式，因为它们添加了类似于锚点的限制，并且不是匹配部分的一部分。

+ `\@!` 顺序否定断言

  + `ice\d\@!` 匹配后面不是数字的 `ice`，例如 `ice` `ice!` `iced5` `icet2`，但是不匹配 `ice2`
  + `s/ice\d\@!/X/g` 将 `iceiceice2` 替换为 `XXice2`
  + `s/par\(.*\<par\>\)\@!/X/g` 匹配之后没有出现词 `par` 的 `par`。`parse and par and sparse` 被转换为 `parse and X and sXse`
  + `at\(\(go\)\@!.\)*par` 匹配`cat,dog,parrot` 而不匹配 `cat,god,parrot`，也就是 `at` 之后跟着 `par` 只要之间没有 `go`

+ `\@<!` 逆序否定断言

  + `_\@<!ice` 匹配没有前导 `_` 的 `ice`
  + `\(cat.*\)\@<!dog` 匹配前面没有出现 `cat` 的 `dog`

+ `\@=` 顺序肯定断言

  + `ice\d\@` 匹配后面是数字的 `ice`
  + `s/ice\d\@=/X/g` 将 `ice ice_2 ice2 iced` 替换为 `ice ice_2 iceX iced`

+ `\@<=` 逆序肯定断言

  + `_\@<=ice` 匹配具有前导 `_` 的 `ice`

  可以指定用于查找逆序环视模式的字节数，这可以显著加快匹配进程。比如，`_\@1<=ice` 仅会搜索 `ice` 前的一个字节。

### 固化分组

当固化分组里的表达式匹配完成之后，不再归还已经匹配到的字符。固化分组主要用于有量词的情况下避免回溯以提高效率。固化分组使用 `\@>` 作为后缀，类似于 `\(pattern\)\@>`。

+ `s/\(0*\)\@>\d\{3,\}/(&)/g` 将三位数加括号，无论是否有前导0，`0501 035 154` 替换为 `(0501) 035 (154)`
  + `s/0*\d\{3,\}/(&)/g` 与 `s/\(0*\)\@>\d\{3,\}/(&)/g`  不同，`0501 035 154` 被替换为 `(0501) (035) (154)`。本例中 `0*` 不是固化分组，`035 ` 的匹配过程中发现 `35` 无法与 `d\{3,\}`，此时进行回溯放弃 `0*` 与 `0` 的匹配，之后匹配成功

### magic 修饰符

#### magic 和 nomagic

这些修饰符改变了修饰符之后的模式某些方面的语法和行为。可以在模式的特定部分按需使用修饰符。

+ \\m magic 模式（默认）

+ \\M nomagic 模式

  + `.`，`*` 和 `~` 不再是元字符
  + `\.`，`\*` 和 `\~` 的行为与元字符一致
  + `^` 和 `$` 仍然是元字符
  + `\Ma.b` 仅匹配 `a.b`
  + `\Ma\.b` 匹配 `a.b`、`a=b`、`a<b` 等

#### very magic

默认的 vim 语法仅支持少量的元字符，类似于 `.`，`*` 和 `~` 。可以通过 `\v` 以获得与其他编程语言类似的语法。


### 设置匹配的开始和结束

逆序的肯定环视和顺序的肯定环视可以被 `\zs` 和 `\ze` 代替。

+ `\zs` 设定匹配的开始
  + `\zs` 将 `sea eat car rat eel tea` 替换为 `secret`，效果与 `s/\(\<\w\)\@<=\w*\W*//g`、`s/\(\<\w\)\@<=\w*\W*//g` 相同
+ `\ze` 设定匹配的结束
  + `s/ice\ze\d/X/g` 将 `ice ice_2 ice2 iced` 替换为 `ice ice_2 X2 iced`，效果与 `s/ice\d\@=/X/g`、`s/ice\(\d\)/X\1/g` 相同

## 多文件、tab、窗口操作

|       命令       |                             效果                             |
| :--------------: | :----------------------------------------------------------: |
|     :e/:edit     |        在同一个 vim 会话中装载新文件（TAB 可以补全）         |
|  :badd \<file\>  |       将文件 file 装载到新的 buffer 中（TAB 可以补全）       |
|       :bN        |                     切换到第 N 个缓冲区                      |
|      :bnext      |               切换到缓冲区列表中的下一个缓冲区               |
|    :bprevious    |               切换到缓冲区列表中的上一个缓冲区               |
|     :buffers     |                        列出所有缓冲区                        |
|     :bfirst      |                      切换到第一个缓冲区                      |
|      :blast      |                     切换到最后一个缓冲区                     |
|      :ball       | 装载所有缓冲区（以多窗口的形式显示所有缓冲区，Ctrl+w 可以进行切换） |
|     :tabnew      |                         打开新的 tab                         |
| :tabnew \<file\> |                 打开新的 tab 并打开文件 file                 |
|    :tabclose     |                         关闭当前 tab                         |
|   :tabprevious   |                       切换到后一个 tab                       |
|   :tabprevious   |                       切换到前一个 tab                       |
|    :tabfirst     |                       切换到第一个 tab                       |
|     :tablase     |                      切换到最后一个tab                       |
|       :new       |                         打开新的窗口                         |
|  :new \<file\>   |                 打开新的窗口并打开文件 file                  |
| Ctrl+w 之后 w/W  |                 在多个窗口之间向下/向上切换                  |

## 宏

vim 中可以通过录制宏实现复杂的操作。

在命令模式下，按下q+小写字母x开始录制名为x的宏（vim 左下角显示 recording@x），然后开始执行 vim 操作，最后以q结束录制，此时名为 x 的宏录制结束，之后可以通过 @x 来执行该宏。

例子：有一个文件如下

~~~~
a
b
c
d
~~~~

要为其每行添加一个行号+空格，可以录制以下宏：

~~~~
首先为第一行添加行号，使其变为 1 a，然后输入qa录制名为a的宏，光标定位到1，录制以下操作：yw，j，P，h，Ctrl+a，最后执行2@a
执行结果
1 a
2 b
3 c
4 d
~~~~

可以通过 :registers 查看已录制的宏。

## 寄存器

vim 提供了许多寄存器，这在多文件操作时特别有效。vim 支持以下几种寄存器：

+ 匿名寄存器：使用 "" 表示，vim 复制和删除的内容放在该寄存器中
+ 命名寄存器：支持26个命名寄存器，可以通过 a-z 以及 A-Z来引用，vim 默认情况下不使用这些寄存器。其中，通过小写字母引用时寄存器中的内容会被覆盖，而通过大字母引用时寄存器中的内容会被追加
+ 数字寄存器：0-9共十个，当复制或删除内容时该 vim 会使用这些寄存器，其中0是复制专用，存放最近复制的内容；当整行删除的时候，被删除的内容会自动存放到1-9中，1存放最近的被删除的行，2存放次近的被删除的行，依此类推
+ 默认寄存器：vim 中还有预定义的默认寄存器
  + 模式寄存器（/）：最近使用的搜索模式
  + 黑洞寄存器（_）：写入该寄存器的内容被丢弃
  + 行内删除寄存器（-）：缓存行内删除的内容
  + 只读寄存器（:/./%/#）：分别缓存最近执行的命令、最近插入的文本、当前文件名、当前交替文件名
  + 表达式寄存器（=）：用于计算表达式的值
  + 选择寄存器（*/+）：与系统剪贴板交互（只有在指定了 +clipboard 选项时才可用）

vim 中使用**“**作为寄存器的入口，通过 **“**+r_name 来引用寄存器。在插入模式下，通过按下 Ctrl+r 之后再输入 r_name 的方式来引用寄存器。比如。按下 `"t4yy` 就可以再寄存器 t 中粘贴4行内容，再按下 `"tp` 就可以从将寄存器 t 中的4行内容粘贴出来。或者在插入模式下，按下 Ctrl+r 后再按下 t 也可以粘贴 t 中的内容。

vim 中可以通过 :registers/:reg 来查看所有寄存器的内容，也可以指定 r_name 查看某一个寄存器的内容。

## diff

与 diff 命令类似，用户可以通过 vim 展示文件差异。

通过 vimdiff <file1\> <file2\> 或者 vim -d  <file1\> <file2\> 进行文件比较。

如果已经打开某个文件，可以通过 :diffsplit filename 或者 :vert diffsplit filename 进行文件比较。

在 vim 配置文件中写入 set noscrollbind 或者执行 :set noscrollbind 可以实现两个文件的同时滚动。

Ctrl+w 可以实现在两个窗口之间的切换。

]c 和 [c 可以实现在不同的差异之间跳转，]c 跳转到上一个差异，[c 跳转到下一个差异。

vim 可以进行差异同步，:diffget 可以将相邻窗口的内容合并到当前窗口，:diffput 可以将当前窗口的内容合并到相邻窗口。

## 参考文献

[Vim Tutorial](https://www.tutorialspoint.com/vim/index.htm)

[编辑器进化 VSCode + Vim](https://zhuanlan.zhihu.com/p/613666124)

[【总结】vim命令使用总结，该来的还是躲不掉](https://zhuanlan.zhihu.com/p/607513080?utm_id=0)

[Learn Vim the Smart Way](https://learnvim.irian.to/)

[Vim Reference Guide](https://learnbyexample.github.io/vim_reference/cover.html)

[固化分组和占有优先](https://baijiahao.baidu.com/s?id=1673451605631969162&wfr=spider&for=pc)